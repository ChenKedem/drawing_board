<html>
<head>
  <title></title>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.3.min.js"></script>
  <script type="text/javascript">

    
    $(document).ready(function() {

      function init(){

        // Error checking, make sure browser support canvas and that correct divs are in the markup
        canvaso = $("#imageView");

        if (!canvaso.length) {
          alert('Error: I cannot find the canvas element!');
          return;
        }

        canvaso = canvaso[0];

        if (!canvaso.getContext) {
          alert('Error: no canvas.getContext!');
          return;
        }

        contexto = canvaso.getContext('2d');
        if (!contexto) {
          alert('Error: failed to getContext!');
          return;
        }

        // Create temporary canvas, above the static canvas
        // This will be used first to preview what will be later drawn on the static canvas
        canvas = $("<canvas id='imageTemp' width='" + canvaso.width + "' height='" + canvaso.height + "'></canvas>");

        canvas.mousedown(ev_canvas) // canvas[0].addEventListener("mousedown", ev_canvas, false)
                                    // ev_canvas(event)      event = { type: "mousedown", offsetX: 412, offsetY: 120, ... ... }
              .mousemove(ev_canvas)
              .mouseup(ev_canvas);

        $("#container").append(canvas);

        canvas = canvas[0];
        context = canvas.getContext('2d');


        // Set tool select box
        var tool_select = $("#dtool .tool");
       
        if (!tool_select.length) {
          alert('Error: failed to get the dtool element!');
          return;
        }

        $(tool_select).click(ev_tool_change);  // tool_select[0].addEventListener("change", ev_tool_change, false)

        // Define the tool kit namespace
        var tool_kit = {};
        var tool_default = 'pencil';
        var tool;

        current_color = $("#pcolor").val();
        
        $("#pcolor").change(function(){
          current_color = this.value;
        });

        fill_color = $("#fcolor").val();

        $("#fcolor").change(function(){
          fill_color = this.value;
        });

        line_width = $("#line_wid :first");

        $("#line_wid").change(function(){
          line_width = $("#line_wid :selected").val();
        });

        function ev_canvas(ev) {
          // This will prevent chrome from changing cursor type to text on drag.
          ev.originalEvent.preventDefault();

          // Calculate event position on canvas and update event object accordingly
          position = getCursorPosition(this, ev)
          ev._x = position.x;
          ev._y = position.y;

          // Can't use tool.ev.type 
          // Because: ev.type = "mousemove",    tool.attribute_name => tool["attribute_name"],      tool.ev.type => tool["ev"].type,
          var func = tool[ev.type];    // ev.type == "mousemove",      tool["mousemove"]
          if (func) {
            func(ev);
          }
        }

        function ev_tool_change(ev) {
          if (tool_kit[$(this).attr("id")]) {
            tool = new tool_kit[$(this).attr("id")]();
          }
        }

        function img_update () {
          contexto.drawImage(canvas, 0, 0);
          context.clearRect(0, 0, canvas.width, canvas.height);
        }

        shapeCreatedEventHandlers = new Array();  

        tool_kit.shapeCreated = function(func){
          shapeCreatedEventHandlers.push(func);
        }

        tool_kit.onShapeCreated = function(shapeObj){
          $.each(shapeCreatedEventHandlers, function() { this(shapeObj) });
        }

        tool_kit.shapeCreated(function(shapeObj) { alert(shapeObj.shape)});

        // Add tool classes to the tool_kit namespace
        tool_kit.pencil = function(){
          var tool = this;
          this.started = false;
          

          this.mousedown = function(ev){
            context.beginPath();
            context.moveTo(ev._x, ev._y);
            tool.started = true;
          }

          this.mousemove = function(ev){
            if (tool.started){
              context.lineTo(ev._x, ev._y);
              context.fillStyle = fill_color;
              context.strokeStyle = current_color;
              context.lineWidth = line_width;
              context.stroke();
            }
          };

          this.mouseup = function(ev){
            if (tool.started){
              tool.mousemove(ev);
              tool.started = false;
              img_update();

              // Call event handler with the information of the shape which just created.
              shapeObj = { shape: "pencil", color: "#512412", position: { x: 51, y: 202 } };              
              tool_kit.onShapeCreated(shapeObj);
            }
          }
        }

        tool_kit.rect = function(){
          var tool = this;
          this.started = false;
          
          this.mousedown = function(ev){
            tool.started = true;
            tool.x0 = ev._x;
            tool.y0 = ev._y;
          };

          this.mousemove = function(ev){
            if(!tool.started){
              return;
            }

            var x = Math.min(ev._x, tool.x0),
                y = Math.min(ev._y, tool.y0),
                w = Math.abs(ev._x - tool.x0),
                h = Math.abs(ev._y - tool.y0);

                context.clearRect(0, 0, canvas.width, canvas.height);

                if(!w || !h){
                  return;
                }

                context.lineWidth = line_width;
                context.fillStyle = fill_color;
                context.fillRect(x , y, w, h);
                context.strokeStyle = current_color;
                context.strokeRect(x, y, w, h);
          };

          this.mouseup = function(ev){
            if (tool.started){
              tool.mousemove(ev);
              tool.started = false;
              img_update();
            }
          };
        };

        tool_kit.line = function(){
          var tool = this;
          this.started = false;

          this.mousedown = function(ev){
            tool.started = true;
            tool.x0 = ev._x;
            tool.y0 = ev._y;
          };

          this.mousemove = function(ev){
            if(!tool.started){
              return;
            }

            context.clearRect(0, 0, canvas.width, canvas.height);

            context.beginPath();
            context.moveTo(tool.x0, tool.y0);
            context.lineTo(ev._x, ev._y);
            context.lineWidth = line_width;
            context.strokeStyle = current_color;
            context.stroke();
            context.fillStyle = fill_color;
            context.closePath();
          };

          this.mouseup = function(ev){
            if(tool.started){
              tool.mousemove(ev);
              tool.started = false;
              img_update();
            }
          };
        };

        tool_kit.ellipse = function(){
          var tool = this;
          this.started = false;

          this.mousedown = function(ev){
            tool.started = true;
            tool.x0 = ev._x;
            tool.y0 = ev._y;
          };

          this.mousemove = function(ev){
            if(!tool.started){
              return;
            }
            
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.beginPath();

            var ellipseWidth = ev._x - tool.x0;
            var ellipseHeight = ev._y - tool.y0;

            context.lineWidth = line_width;
            context.drawEllipse(tool.x0, tool.y0, ellipseWidth, ellipseHeight);

            context.fillStyle = fill_color;
            context.fill();
            context.strokeStyle = current_color;
            context.stroke();
            context.closePath();
          };

          this.mouseup = function(ev){
            if(tool.started){
              tool.mousemove(ev);
              tool.started = false;
              img_update();
            }
          };
        };  

        tool_kit.eraser = function(){
          var tool = this;
          this.started = false;

          this.mousedown = function(ev){
            context.beginPath();
            context.moveTo(ev._x, ev._y);
            tool.started = true;
          };

          this.mousemove = function(ev){
            if (tool.started){
              context.lineTo(ev._x, ev._y);
              context.fillStyle = "#FFFFFF";
              context.strokeStyle = "#FFFFFF";
              context.lineWidth = line_width;
              context.stroke();
            }
          };

          this.mouseup = function(ev){
            if (tool.started){
              tool.mousemove(ev);
              tool.started = false;
              img_update();
            }
          }
        }

        if (tool_kit[tool_default]){
          tool = new tool_kit[tool_default]();
          tool_select.value = tool_default;
        }
      }

      init();
    });

    // This method is for calculating mouse x and y cursor positions and is cross browser supported
    function getCursorPosition(canvas, event) {
      var x, y;

      canoffset = $(canvas).offset();
      x = event.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - Math.floor(canoffset.left);
      y = event.clientY + document.body.scrollTop + document.documentElement.scrollTop - Math.floor(canoffset.top) + 1;

      return { x: x, y: y };
    }

    // Add drawEllipse method to the canvas context prototype
    CanvasRenderingContext2D.prototype.drawEllipse = function(x, y, w, h) {
      var kappa = .5522848;
          ox = (w / 2) * kappa, // control point offset horizontal
          oy = (h / 2) * kappa, // control point offset vertical
          xe = x + w,           // x-end
          ye = y + h,           // y-end
          xm = x + w / 2,       // x-middle
          ym = y + h / 2;       // y-middle

      this.moveTo(x, ym);
      this.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
      this.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
      this.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
      this.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
    }
  </script>

  <style type="text/css">

    #container
    {
      position: relative;
    }
    #imageView { border: 1px solid #000; }
    #imageTemp { position: absolute; top: 1px; left: 1px; }

    #panel
    {
      background: url("images/panel.png");
      background-repeat: no-repeat;
      /*background-color: #FF4400;*/
      width: 800px;
      height: 130px;
      /*border: 5px solid #FF1100;*/
      margin: 20px 10px 20px 20px;
      padding: 20px 0px 0px 40px;
      /*border-radius: 20px;*/
      /*box-shadow: 10px 10px 5px #888888;*/
    }

    .tools
    {
      list-style: none;
      display: inline;
      margin-top: 40px;
      padding: 20px 0px 0px 0px;

    }

    .tool
    {
      display: inline;
      cursor: pointer;
      /*opacity: 0.9;*/
    }

    .tool:hover
    {
      opacity: 1;
    }

    .pan_el
    {
      display: inline-block;
    }

    #imageTemp {
      cursor: crosshair;
    }

  </style>
</head>
<body>
  <div id="panel">
    <ul id="dtool" class="tools">
      <li id="pencil" class="tool"><img src="images/pencil_button.png" title="Pencil"/></li>
      <li id="line" class="tool"><img src="images/lines_button.png" title="Line" /></li>      
      <li id="rect" class="tool"><img src="images/rectangle_button.png" title="Rectangle" /></li>
      <li id="ellipse" class="tool"><img src="images/ellipse_button.png" title="Ellipse" /></li>
      <li id="eraser" class="tool"><img src="images/eraser_button.png" title="Eraser" /></li>
    </ul>

    <p class="pan_el">
      <label>Line Width:</br>
        <select id="line_wid">
          <option value="1">1px</option>
          <option value="2">2px</option>
          <option value="3">3px</option>
          <option value="4">4px</option>
          <option value="5">5px</option>
          <option value="6">6px</option>
        </select>
      </label>
    </p>
   
    <p class="pan_el">Color:</br><input type="color" name="color" id="pcolor" /></p>
    
    <p class="pan_el">Fill Color:</br><input type="color" name="fcolor" id="fcolor" /></p>
  </div>  

  <div id="container">
    <canvas id="imageView" width="400" height="300" style="border:1px solid black"></canvas>
  </div>
</body>
</html>